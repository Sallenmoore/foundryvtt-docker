---
dist: xenial
language: python
python: 3.7
services: docker
env:
  global:
    - IMAGE_NAME=dhsncats/example
    - DOCKER_USER=felddy
    - secure: >-
        GWxja6rCcevNRay3uOGEt1wpzGOAoKgfquyror60VtkG07GCJ/rCBa/jNsTRRwwDxYW
        MqY6xQlAU+GzNeuBxKAlmyrLRRYZDmcBpPgQQPbiC0b5ftGCzTuhdYAj4Hg+LyHKbNP
        H0zsXfQRy2NdWPJ8rr3RFL89a/If0hJVL5OEEHfmzpfvHoDvBJQwhmL2sPZizgCsgh6
        eRStRvUWj3taVb5VZ1uIlet8P3g7azkD7tTNx+wAxhjlLpaQfBcy/CC27ogw+QOvgdF
        kefskYz54LLzTyXYhRhACjuGaukpBvQBFzBi3MOFYoLj4kb+9b3mqHlnQZLOSo2zlWV
        30mTC7eed5KE64MuQ6I1E72B0rnAoVpnwAjXVIvzfhKBuzbhS54tWjKbqK6UAGxbg6t
        wJDiNaB+nYk6zozJ93TQT02XDUOdDS45hO2Kc/CUwJbrZc7V4aYN6Dj30tWy8d2TI8s
        GMPuJm8tyxpT/h2eUUPhVzhMCk+4efIBa6cb99wZgkphLmWQefLLpZy8pMwOH7c3ywU
        +6tVPBZxSEm4tFRYyPwgl9qvzE8E0WM3FPNgwVO9aypx61HcO8NVD7alUW2j+s3taHX
        aVpaCtsf+bpsXPro3/ofst+FHiFPZGBL2iiSIYtFYI4hkDFq9iGGGexo9zgYS6CMexu
        YoZtThDw6kaLI=
cache:
  pip: true
  directories:
    - "$HOME/.cache/pre-commit"
install:
  - pip install --upgrade --requirement requirements-test.txt
  - version=$(./bump_version.sh show)
  - docker build
    --tag "$IMAGE_NAME"
    --build-arg GIT_COMMIT=$(git log -1 --format=%H)
    --build-arg GIT_REMOTE=$(git remote get-url origin)
    --build-arg VERSION=${version}
    .
script:
  - pre-commit run --all-files
  - pytest --verbose
before_deploy:
  - IFS='.' read -r -a version_array <<< "$version"
  - docker login --username "$DOCKER_USER" --password "$DOCKER_PW"
  - docker tag "$IMAGE_NAME" "${IMAGE_NAME}:latest"
  - docker tag "$IMAGE_NAME" "${IMAGE_NAME}:${version}"
  - docker tag "$IMAGE_NAME"
    "${IMAGE_NAME}:${version_array[0]}.${version_array[1]}"
  - docker tag "$IMAGE_NAME" "${IMAGE_NAME}:${version_array[0]}"
deploy:
  - provider: script
    script: docker push "${IMAGE_NAME}:latest" &&
      docker push "${IMAGE_NAME}:${version}" &&
      docker push "${IMAGE_NAME}:${version_array[0]}.${version_array[1]}" &&
      docker push "${IMAGE_NAME}:${version_array[0]}"
    on:
      tags: true
      python: '3.7'
